<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Serendi — Mon profil</title>
  <link rel="icon" href="assets/logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .other-input{margin-top:8px;display:none}
    .grid-2{display:grid;gap:16px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width: 720px){.grid-2{grid-template-columns:1fr}}
    .hint{opacity:.85;font-size:14px}
  </style>
  <script src="assets/config.js"></script>
  <script src="assets/app.js" defer></script>
</head>
<body>
<header>
  <a class="logo" href="index.html">
    <img src="assets/logo.svg" alt="logo">
    <strong>Serendi</strong>
  </a>
  <nav>
    <a href="index.html">Radar</a>
    <a href="onboarding.html">Profil</a>
    <a href="settings.html">Réglages</a>
    <a href="privacy.html">Vie privée</a>
    <a href="apropos.html">À propos</a>
  </nav>
</header>

<main class="container">
  <div class="card">
    <h1>Mon profil</h1>
    <p class="hint">Tout est enregistré localement et réutilisé automatiquement. Tu peux préciser “Autre” quand une option ne te correspond pas.</p>

    <!-- IDENTITÉ -->
    <div class="grid-2">
      <label>Nom / Pseudo
        <input id="display_name" placeholder="ex: Eva" />
      </label>
      <label>Type de relation (multi)
        <select id="relation_type" multiple>
          <option value="Amitié">Amitié</option>
          <option value="Rencontre">Rencontre</option>
          <option value="Relation sérieuse">Relation sérieuse</option>
          <option value="Sortie">Sortie</option>
          <option value="Conversation">Conversation</option>
          <option value="Autre">Autre 
        </select>
        <input id="relation_type_other" class="other-input" placeholder="Préciser…" />
      </label>
    </div>

    <!-- QUI JE SUIS -->
    <h2 style="margin-top:16px">Qui je suis</h2>
    <div class="grid-2">
      <label>Genre (multi)
        <select id="my_gender" multiple>
          <option value="Femme">Femme</option>
          <option value="Homme">Homme</option>
          <option value="Personne non binaire">Personne non binaire</option>
          <option value="Personne trans">Personne trans</option>
          <option value="Autre">Autre 
        </select>
        <input id="my_gender_other" class="other-input" placeholder="Préciser…" />
      </label>
      <label>Orientation (optionnel, multi)
        <select id="my_orientation" multiple>
          <option value="Gay">Gay</option>
          <option value="Lesbienne">Lesbienne</option>
          <option value="Bisexuel(le)">Bisexuel(le)</option>
          <option value="Pansexuel(le)">Pansexuel(le)</option>
          <option value="Asexuel(le)">Asexuel(le)</option>
          <option value="Queer">Queer</option>
          <option value="Hétéro">Hétéro</option>
          <option value="Autre">Autre 
        </select>
        <input id="my_orientation_other" class="other-input" placeholder="Préciser…" />
      </label>
    </div>

    <div class="grid-2" style="margin-top:8px">
      <label>Âge
        <input id="age" type="number" min="18" max="99" placeholder="29" />
      </label>
      <label>Taille (cm)
        <input id="height" type="number" min="120" max="230" placeholder="173" />
      </label>
    </div>

    <div class="grid-2" style="margin-top:8px">
      <label>Cheveux
        <select id="hair">
          <option value="">—</option>
          <option value="Blonds">Blonds</option>
          <option value="Bruns">Bruns</option>
          <option value="Noirs">Noirs</option>
          <option value="Roux">Roux</option>
          <option value="Gris/Blanc">Gris/Blanc</option>
          <option value="Chauve">Chauve</option>
          <option value="Autre">Autre (préciser)</option>
        </select>
        <input id="hair_other" class="other-input" placeholder="Préciser…" />
      </label>
      <label>Type de corps
        <select id="body">
          <option value="">—</option>
          <option value="Mince">Mince</option>
          <option value="Athlétique">Athlétique</option>
          <option value="Avec formes">Avec formes</option>
          <option value="Massif">Massif</option>
          <option value="Musclé">Musclé</option>
          <option value="Autre">Autre (préciser)</option>
        </select>
        <input id="body_other" class="other-input" placeholder="Préciser…" />
      </label>
    </div>

    <div class="grid-2" style="margin-top:8px">
      <label>Religion (optionnel)
        <select id="religion">
          <option value="">—</option>
          <option value="Aucune">Aucune</option>
          <option value="Bouddhisme">Bouddhisme</option>
          <option value="Christianisme">Christianisme</option>
          <option value="Hindouisme">Hindouisme</option>
          <option value="Islam">Islam</option>
          <option value="Judaïsme">Judaïsme</option>
          <option value="Spiritualité">Spiritualité</option>
          <option value="Autre">Autre (préciser)</option>
        </select>
        <input id="religion_other" class="other-input" placeholder="Préciser…" />
      </label>
      <label>Régime (optionnel)
        <select id="diet">
          <option value="">—</option>
          <option value="Omnivore">Omnivore</option>
          <option value="Végétarien">Végétarien</option>
          <option value="Végétalien/Vegan">Végétalien/Vegan</option>
          <option value="Pescétarien">Pescétarien</option>
          <option value="Halal">Halal</option>
          <option value="Kasher">Kasher</option>
          <option value="Sans gluten">Sans gluten</option>
          <option value="Autre">Autre (préciser)</option>
        </select>
        <input id="diet_other" class="other-input" placeholder="Préciser…" />
      </label>
    </div>

    <label style="margin-top:8px">Petite description (≤ 300 mots)
      <textarea id="bio" rows="4" placeholder="Quelques mots sur toi…"></textarea>
    </label>

    <label style="margin-top:8px">Comment me reconnaître
      <input id="recognize" placeholder="manteau rouge, robe noire…" />
    </label>

    <!-- RECHERCHES -->
    <h2 style="margin-top:16px">Ce que je recherche</h2>
    <div class="grid-2">
      <div>
        <label>Genre(s) souhaité(s)</label>
        <div class="row">
          <label class="check"><input type="checkbox" id="seek_women" /> Femmes</label>
          <label class="check"><input type="checkbox" id="seek_men" /> Hommes</label>
          <label class="check"><input type="checkbox" id="seek_nb" /> Non binaires</label>
          <label class="check"><input type="checkbox" id="seek_trans" /> Trans</label>
        </div>
      </div>
      <div>
        <label>Âge souhaité</label>
        <div class="row">
          <input id="want_age_min" type="number" min="18" max="99" placeholder="Min." />
          <input id="want_age_max" type="number" min="18" max="99" placeholder="Max." />
        </div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:8px">
      <div>
        <label>Taille souhaitée (cm)</label>
        <div class="row">
          <input id="want_h_min" type="number" min="120" max="230" placeholder="Min." />
          <input id="want_h_max" type="number" min="120" max="230" placeholder="Max." />
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <button class="btn" id="btn-save-profile2">Enregistrer</button>
      <button class="btn ghost" onclick="history.back()">Annuler</button>
    </div>
  </div>

  <div class="card">
    <h2>Mes demandes envoyées (dernière heure)</h2>
    <div id="sent-panel" class="card" style="background:#21122f"><i>Aucune demande envoyée dans l’heure.</i></div>
  </div>

  <div class="card">
    <h2>Rencontre en cours</h2>
    <div id="accepted-panel" class="card" style="background:#21122f"><i>Aucune rencontre active.</i></div>
  </div>
</main>

<div id="toast"></div>

<script>
// ===== Helpers "multi + Autre" =====
function getMultiWithOther(selId){
  const sel = document.getElementById(selId);
  const other = document.getElementById(selId + '_other');
  const values = Array.from(sel.selectedOptions).map(o => o.value);
  const hasOther = values.includes('Autre');
  if (other) other.style.display = hasOther ? '' : 'none';
  if (hasOther && other.value.trim()) values.push('Autre:' + other.value.trim());
  return values;
}
function setMultiWithOther(selId, values){
  const sel = document.getElementById(selId);
  const other = document.getElementById(selId + '_other');
  if (!sel) return;
  const arr = Array.isArray(values) ? values : (values ? [values] : []);
  const plain = [];
  let otherVal = '';
  arr.forEach(v=>{
    if (typeof v !== 'string') return;
    if (v.startsWith('Autre:')) otherVal = v.slice(6).trim();
    else plain.push(v);
  });
  Array.from(sel.options).forEach(opt=>{
    opt.selected = plain.includes(opt.value) || (opt.value==='Autre' && otherVal);
  });
  if (other){
    const show = otherVal || Array.from(sel.selectedOptions).some(o=>o.value==='Autre');
    other.style.display = show ? '' : 'none';
    if (otherVal) other.value = otherVal;
  }
}

// ===== Helpers "select + Autre" =====
function getSelectWithOther(id){
  const sel = document.getElementById(id);
  const other = document.getElementById(id + '_other');
  const v = sel.value || '';
  const isOther = v === 'Autre';
  if (other) other.style.display = isOther ? '' : 'none';
  if (isOther && other.value.trim()) return 'Autre:' + other.value.trim();
  return v;
}
function setSelectWithOther(id, value){
  const sel = document.getElementById(id);
  const other = document.getElementById(id + '_other');
  if (!sel) return;
  let base = value || '';
  let otherVal = '';
  if (typeof base === 'string' && base.startsWith('Autre:')){
    otherVal = base.slice(6).trim();
    base = 'Autre';
  }
  const exists = Array.from(sel.options).some(o=>o.value===base);
  sel.value = exists ? base : (otherVal ? 'Autre' : '');
  if (other){
    other.style.display = (sel.value === 'Autre') ? '' : 'none';
    if (otherVal) other.value = otherVal;
  }
}

// ===== Autosave simple =====
let _svTimer=null;
function autosaveProfile(p){
  clearTimeout(_svTimer);
  _svTimer = setTimeout(()=>{
    try{ localStorage.setItem('profile', JSON.stringify(p)); }catch(e){}
  }, 200);
}

// ===== Wire "Autre (préciser)" =====
function wireOtherInputs(){
  ['my_gender','my_orientation','relation_type'].forEach(id=>{
    const sel = document.getElementById(id);
    const other = document.getElementById(id+'_other');
    if (sel){
      sel.addEventListener('change', ()=>{
        const hasOther = Array.from(sel.selectedOptions).some(o=>o.value==='Autre');
        if (other) other.style.display = hasOther ? '' : 'none';
        collectAndSave();
      });
    }
    if (other){ other.addEventListener('input', collectAndSave); other.addEventListener('change', collectAndSave); }
  });
  ['hair','body','religion','diet'].forEach(id=>{
    const sel = document.getElementById(id);
    const other = document.getElementById(id+'_other');
    if (sel){
      sel.addEventListener('change', ()=>{
        if (other) other.style.display = (sel.value==='Autre') ? '' : 'none';
        collectAndSave();
      });
    }
    if (other){ other.addEventListener('input', collectAndSave); other.addEventListener('change', collectAndSave); }
  });
}

// ===== Pré-remplissage & autosave =====
document.addEventListener('DOMContentLoaded', ()=>{
  let p={}; try{ p = JSON.parse(localStorage.getItem('profile')||'{}'); }catch(e){}

  // Textes
  if (p.display_name) document.getElementById('display_name').value = p.display_name;
  if (p.age) document.getElementById('age').value = p.age;
  if (p.height) document.getElementById('height').value = p.height;
  if (p.bio) document.getElementById('bio').value = p.bio;
  if (p.recognize) document.getElementById('recognize').value = p.recognize;

  // Multi + Autre
  setMultiWithOther('my_gender', p.my_gender);
  setMultiWithOther('my_orientation', p.my_orientation);
  setMultiWithOther('relation_type', p.relation_type);

  // Select + Autre
  setSelectWithOther('hair', p.hair);
  setSelectWithOther('body', p.body);
  setSelectWithOther('religion', p.religion);
  setSelectWithOther('diet', p.diet);

  // Recherche
  if (p.seek){
    document.getElementById('seek_women').checked = !!p.seek.women;
    document.getElementById('seek_men').checked   = !!p.seek.men;
    document.getElementById('seek_nb').checked    = !!p.seek.nb;
    document.getElementById('seek_trans').checked = !!p.seek.trans;
  }
  if (p.want){
    if (p.want.age){
      document.getElementById('want_age_min').value = p.want.age[0]||'';
      document.getElementById('want_age_max').value = p.want.age[1]||'';
    }
    if (p.want.height){
      document.getElementById('want_h_min').value = p.want.height[0]||'';
      document.getElementById('want_h_max').value = p.want.height[1]||'';
    }
  }

  // Autosave on change
  document.querySelectorAll('input,textarea,select').forEach(el=>{
    el.addEventListener('input', collectAndSave);
    el.addEventListener('change', collectAndSave);
  });

  wireOtherInputs();

  const btn = document.getElementById('btn-save-profile2');
  if (btn){
    btn.addEventListener('click', ()=>{
      collectAndSave(); // force save local
      location.href = 'index.html';
    });
  }
});

function collectAndSave(){
  const p = {
    display_name: (document.getElementById('display_name').value||'').trim(),
    age: Number(document.getElementById('age').value)||null,
    height: Number(document.getElementById('height').value)||null,
    bio: (document.getElementById('bio').value||'').slice(0,300),
    recognize: (document.getElementById('recognize').value||'').trim(),

    my_gender: getMultiWithOther('my_gender'),
    my_orientation: getMultiWithOther('my_orientation'),
    relation_type: getMultiWithOther('relation_type'),

    hair: getSelectWithOther('hair'),
    body: getSelectWithOther('body'),
    religion: getSelectWithOther('religion') || '',
    diet: getSelectWithOther('diet') || '',

    seek: {
      women: document.getElementById('seek_women').checked,
      men:   document.getElementById('seek_men').checked,
      nb:    document.getElementById('seek_nb').checked,
      trans: document.getElementById('seek_trans').checked
    },
    want: {
      age: [
        Number(document.getElementById('want_age_min').value)||null,
        Number(document.getElementById('want_age_max').value)||null
      ],
      height: [
        Number(document.getElementById('want_h_min').value)||null,
        Number(document.getElementById('want_h_max').value)||null
      ]
    }
  };
  autosaveProfile(p);
}
</script>
</body>
</html>




